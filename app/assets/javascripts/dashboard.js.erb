$(window).bind('page:change', function () {
    initDashboard();
});
function initDashboard() {
    $("#dashboard .task-content").sortable({
        item: '.task-item',
        connectWith: '#dashboard .task-content',
        placeholder: 'placeholder',
        activeClass: "ui-state-hover",
        hoverClass: "ui-state-active"
    });

    $("#dashboard .task-content").droppable({
        accept: ":not(.ui-sortable-helper)",
        activeClass: "ui-state-hover",
        hoverClass: "ui-state-active",
        tolerance: "intersect",
        greedy: true,
        drop: function (event, ui) {
            $(this).append(ui.helper);
            dropZone = $(event.target);
            status = dropZone.attr('data-task-status');
            task_id = $(ui.helper).attr('data-task-id');
            project_id = $(ui.helper).attr('data-project-id');
            updateTask("status_id", status, project_id, task_id);
        },
        accept: function (elem) {
            return !$(this).has(elem).length;
        }
    });

    $(".add-attachment").droppable({
        activeClass: "ui-state-hover",
        hoverClass: "ui-state-active",
        tolerance: "intersect",
        greedy: true,
        drop: function (event, ui) {
            console.log($(event.target));
        }
    });

    $(".project-title").click(function () {
        id = $(this).attr('data-id');
        $.ajax({
            url: "/projects/" + id + "/edit",
            type: 'get',
            success: function (res) {
                $("#small-modal .modal-header").text("Project");
                $("#small-modal .modal-body").html(res);
                $("#small-modal").modal('show');
            }
        });
    });

    $(".task-item").dblclick(function () {
        task_id = $(this).attr('data-task-id');
        project_id = $(this).attr('data-project-id');
        if (task_id == '' || project_id == '') {
            popupMessage('internal error', 'error');
            return false;
        }
        $.ajax({
            url: "/projects/" + project_id + "/tasks/" + task_id,
            type: 'get',
            success: function (res) {
                $("#x-large-modal").modal('show');
                $("#x-large-modal .modal-body").html(res);
            }
        });
    });

    $(document).on('change', '.file_upload', function (e) {
        var ofile = this.files[0];
        var formdata;
        if (FormData) {
            formdata = new FormData();
            formdata.append("attachment[file]", ofile);
        }
        task_id = $(this).attr('data_task_id');
        if(task_id == '') {
            popupMessage("Error", 'error');
        }
        $.ajax({
            url: "/tasks/"+task_id+"/attachments",
            data: formdata,
            type: 'POST',
            success: function (res) {
                $('#response').html(res);
            },
            error: function (xhr, rrr, error) {
                alert(error);
            },
            processData: false,
            contentType: false
        });
    });

    var old_value = '', new_value ='';
    $(document).on('click', '.task-description', function() {
        old_value = $(this).text().trim();
        $(this).addClass('editable-content');
    });

    $(document).on('blur', '.task-description', function() {
        new_value = $(this).text().trim();
        $(this).removeClass('editable-content');
        if(old_value != new_value) {
            task_id = $(".task-details").attr('data-task-id');
            project_id = $(".task-item").first().attr('data-project-id');
            updateTask('description', new_value, project_id, task_id);
        }
    });

    /* Edit task effort value */

    $(document).on('click', ".task-priority", function() {
        $(".priority-dropdown").toggle();
    });

    $(document).on("blur", ".progress-effort, .progress-spend", function() {
        var progress = $(this).text().trim();
        var field = $(this).attr('data-task-field').trim();
        task_id = $(".task-details").attr('data-task-id');
        project_id = $(".task-item").first().attr('data-project-id');
        updateTask(field, progress, project_id, task_id);
    });

    $(document).on("keypress", ".progress-effort, .progress-spend", function(e) {
        if(e.which == 13) {
            return false;
        }
    });

    $(document).on('click', '.change-priority', function() {
        task_id = $(".task-details").attr('data-task-id');
        project_id = $(".task-item").first().attr('data-project-id');
        field = $(this).attr('data-task-field');
        var priority = $(this).attr('data-value');
        new_priority = "/assets/task_"+priority.toLowerCase()+".png";
        $(this).parents('ul').prev().find('img').attr('src', new_priority);
        updateTask(field, priority, project_id, task_id);
        $(".priority-dropdown").hide();
    });


    $(document).on('click', ".assigned-people", function() {
       $('.unassigned-pophover').toggle();
    })


    function updateTask(field, value, project_id, task_id) {
        $.ajax({
            url: "/projects/" + project_id + "/tasks/" + task_id,
            type: 'put',
            data: {field: field, value: value},
            dataType: 'script',
            success: function() {
                popupMessage("Update task status", 'info');
            },
            error: function() {
                popupMessage("Error", 'error');
            }
        });
    }
}